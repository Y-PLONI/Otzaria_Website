# מערכת סטטוסים לספרים

## תיאור
מערכת לניהול סטטוסים של ספרים שהועלו למערכת. מאפשרת למנהלים לעקוב אחר מצב הטיפול בכל ספר.

**חשוב:** הסטטוס הוא ברמת הספר (קבוצה), לא ברמת העלאה בודדת. כלומר:
- אם יש העלאה אחת בלבד - עריכת הסטטוס מעדכנת אותה
- אם יש מספר העלאות לאותו ספר - עריכת הסטטוס מעדכנת את כולן יחד

## סטטוסים ברירת מחדל

1. **לא נבדק** (`not_checked`) - ברירת מחדל לכל העלאה חדשה
2. **דורש טיפול** (`needs_attention`) - ספר שזקוק לתיקונים או עבודה נוספת
3. **תקין ומוכן להכנסה** (`ready`) - ספר שעבר בדיקה ומוכן להיכנס לספרייה
4. **הוכנס לספרייה** (`added_to_library`) - ספר שכבר הוכנס למערכת

## תכונות

### עריכת סטטוס ספר
- לחיצה על כפתור העריכה ליד הסטטוס
- בחירת סטטוס חדש מהרשימה
- שמירה מיידית
- **אם לספר יש מספר העלאות - כולן מתעדכנות יחד**

### הגדרות סטטוסים
- כפתור "הגדרות סטטוסים" בראש העמוד
- הוספת סטטוסים חדשים
- עריכת תוויות קיימות
- שינוי צבעי רקע
- מחיקת סטטוסים

## לוגיקה

הסטטוס נשמר ברמת ההעלאה במסד הנתונים, אך מנוהל ברמת הספר בממשק:

1. כל העלאה יכולה להשתייך לספר (מזוהה לפי שם בסיסי ללא מספר עמוד)
2. כאשר עורכים סטטוס, המערכת מוצאת את כל ההעלאות של אותו ספר
3. כל ההעלאות מתעדכנות עם אותו סטטוס
4. בממשק מוצג הסטטוס של ההעלאה הראשונה (כולן זהות)

## API Endpoints

### קבלת הגדרות סטטוסים
```
GET /api/admin/book-statuses
```
דורש הרשאות אדמין.

### עדכון הגדרות סטטוסים
```
POST /api/admin/book-statuses
Body: { statuses: { key: { label, color }, ... } }
```
דורש הרשאות אדמין.

### עדכון סטטוס מרובה (משמש לעדכון ספר)
```
PUT /api/admin/uploads/batch-update-book-status
Body: { uploadIds: [], bookStatus }
```
דורש הרשאות אדמין. מעדכן את כל ההעלאות של הספר.

## מבנה נתונים

### Upload Model
```javascript
{
  bookStatus: { 
    type: String, 
    default: 'not_checked' 
  }
}
```

### SystemConfig
```javascript
{
  key: 'book_statuses',
  value: {
    status_key: {
      label: 'תווית בעברית',
      color: '#hex_color'
    }
  }
}
```

## התקנה

1. הרץ את הסקריפט להוספת השדה לרשומות קיימות:
```bash
node scripts/add-book-status-field.js
```

2. הגדרות הסטטוסים נשמרות אוטומטית במסד הנתונים בפעם הראשונה שנכנסים לעמוד.

## שימוש

1. היכנס לעמוד ניהול העלאות: `/library/admin/uploads`
2. לחץ על כפתור העריכה ליד הסטטוס של כל ספר
3. בחר סטטוס חדש ושמור
4. **אם לספר יש מספר העלאות - כולן יתעדכנו אוטומטית**
5. להגדרת סטטוסים מותאמים אישית - לחץ על "הגדרות סטטוסים"

## אבטחה

כל ה-API endpoints מוגנים באימות אדמין:
```javascript
const session = await getServerSession(authOptions);
if (session?.user?.role !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
}
```
